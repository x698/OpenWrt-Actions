# Author: P3TERX (Modified and Optimized)
#=================================================
name: üíª X86_64
permissions:
  contents: write
  actions: read
on:
  workflow_dispatch:
    inputs:
      lan_addr:
        description: "üìç ÈªòËÆ§ LAN Âú∞ÂùÄ"
        default: "10.0.0.1"
        required: true
        type: string
      root_password:
        description: "üîë Root ÂØÜÁ†Å"
        default: "password"
        required: false
        type: string
      docker:
        description: "üêã Docker ÊîØÊåÅ"
        type: boolean
        default: true
      ssrp:
        description: "üöÄ ShadowSocksR Plus+"
        type: boolean
        default: true
      passwall:
        description: "üåê Passwall"
        type: boolean
        default: true
      nikki:
        description: "üì¶ Nikki"
        type: boolean
        default: true
      openclash:
        description: "‚ö° OpenClash"
        type: boolean
        default: true
      lucky:
        description: "üçÄ Lucky"
        type: boolean
        default: true
      oaf:
        description: "üõ°Ô∏è OpenAppFilter"
        type: boolean
        default: true
      force_clean:
        description: "üßπ Âº∫Âà∂Ê∏ÖÁêÜÁºìÂ≠ò"
        type: boolean
        default: false
env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  CONFIG_FILE: configs/x86_64.config
  DIY_SCRIPT: scripts/diy-x86_64_demo.sh
  FEEDS_CONF: feeds.conf.default
  CLASH_KERNEL: amd64
  UPLOAD_ARTIFACTS: false
  UPLOAD_RELEASE: true
  FIRMWARE_TAG: X86_64
  TZ: Asia/Shanghai
  DEBIAN_FRONTEND: noninteractive
concurrency:
  group: build-${{ github.ref }}-${{ github.event.inputs.lan_addr }}
  cancel-in-progress: false
jobs:
  build:
    name: üèóÔ∏è Build OpenWrt
    runs-on: ubuntu-24.04
    timeout-minutes: 720
    outputs:
      firmware_path: ${{ steps.organize.outputs.firmware_path }}
      kernel_version: ${{ steps.organize.outputs.kernel_version }}
    steps:
      # ============================================
      # 1. ÁéØÂ¢ÉÂàùÂßãÂåñ
      # ============================================
      - name: üîß Setup Environment
        id: env
        run: |
          sudo timedatectl set-timezone "$TZ"
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          VERSION=$(date +'%Y.%m.%d')
          BUILD_ID="${{ github.run_number }}-${GITHUB_SHA::7}"
          
          echo "BUILD_VERSION=$VERSION" >> $GITHUB_ENV
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
          
      # ============================================
      # 2. Á≥ªÁªü‰ºòÂåñ
      # ============================================
      - name: üßπ Free Disk Space
        uses: sbwml/actions@free-disk
        
      - name: üíæ Setup Swap & Memory Optimization
        run: |
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo "vm.swappiness = 10" | sudo tee -a /etc/sysctl.conf
          echo "vm.vfs_cache_pressure = 50" | sudo tee -a /etc/sysctl.conf
          sudo sysctl -p
          
      # ============================================
      # 3. ‰ª£Á†ÅÊ£ÄÂá∫
      # ============================================
      - name: ‚úÖ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          
      # ============================================
      # 4. ÊûÑÂª∫‰æùËµñÂÆâË£Ö
      # ============================================
      - name: üõ†Ô∏è Build System Setup
        uses: sbwml/actions@openwrt-build-setup
        
      - name: üì¶ Install LLVM
        uses: sbwml/actions@install-llvm
      # ============================================
      # 5. Ê∫êÁ†ÅÂáÜÂ§á‰∏é‰ø°ÊÅØÈááÈõÜ
      # ============================================
      - name: üì• Prepare OpenWrt Source
        run: |
          echo "üîÑ Cloning OpenWrt source..."
          rm -rf openwrt
          
          for attempt in 1 2 3; do
            if git clone --depth=1 "$REPO_URL" -b "$REPO_BRANCH" openwrt; then
              break
            fi
            echo "‚ùå Attempt $attempt failed, retrying..."
            sleep 15
          done
          cd openwrt
          echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
          
          COMMIT_INFO=$(git log -1 --pretty=format:'%H|%an|%ai|%s')
          IFS='|' read -r COMMIT_HASH COMMIT_AUTHOR COMMIT_DATE COMMIT_MESSAGE <<< "$COMMIT_INFO"
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          echo "COMMIT_AUTHOR=$COMMIT_AUTHOR" >> $GITHUB_ENV
          echo "COMMIT_DATE=$COMMIT_DATE" >> $GITHUB_ENV
          echo "COMMIT_MESSAGE=$COMMIT_MESSAGE" >> $GITHUB_ENV
      # ============================================
      # 6. ‰ºòÂåñÁºìÂ≠òÁ≠ñÁï•
      # ============================================
      - name: ‚òÅÔ∏è Cache Toolchain
        if: github.event.inputs.force_clean != 'true'
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/toolchain-*
            openwrt/build_dir/toolchain-*
          key: toolchain-${{ env.REPO_BRANCH }}-${{ env.WEEK_KEY }}-v7  # üî• ÁâàÊú¨Âè∑Áªü‰∏ÄÂçáÁ∫ß
          restore-keys: |
            toolchain-${{ env.REPO_BRANCH }}-${{ env.WEEK_KEY }}-
            toolchain-${{ env.REPO_BRANCH }}-
      - name: ‚òÅÔ∏è Cache Staging Directory
        if: github.event.inputs.force_clean != 'true'
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/host*
            openwrt/staging_dir/hostpkg
          key: staging-${{ env.REPO_BRANCH }}-${{ env.WEEK_KEY }}-v5  # üî• ÁâàÊú¨Âè∑ÂçáÁ∫ß
          restore-keys: |
            staging-${{ env.REPO_BRANCH }}-${{ env.WEEK_KEY }}-
            staging-${{ env.REPO_BRANCH }}-
      - name: ‚òÅÔ∏è Cache Build Host
        if: github.event.inputs.force_clean != 'true'
        uses: actions/cache@v4
        with:
          path: |
            openwrt/build_dir/host*
          key: buildhost-${{ env.REPO_BRANCH }}-${{ env.PLUGINS_HASH }}-${{ env.WEEK_KEY }}-v5  # üî• ÁâàÊú¨Âè∑ÂçáÁ∫ß
          restore-keys: |
            buildhost-${{ env.REPO_BRANCH }}-${{ env.PLUGINS_HASH }}-
            buildhost-${{ env.REPO_BRANCH }}-
            
      - name: ‚òÅÔ∏è Cache Downloads
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: downloads-${{ env.REPO_BRANCH }}-${{ env.PLUGINS_HASH }}-v6  # üî• ÁâàÊú¨Âè∑ÂçáÁ∫ß
          restore-keys: |
            downloads-${{ env.REPO_BRANCH }}-${{ env.PLUGINS_HASH }}-
            downloads-${{ env.REPO_BRANCH }}-
            
      - name: ‚òÅÔ∏è Cache ccache
        if: github.event.inputs.force_clean != 'true'
        uses: actions/cache@v4
        with:
          path: openwrt/.ccache
          key: ccache-${{ env.REPO_BRANCH }}-${{ env.PLUGINS_HASH }}-${{ env.WEEK_KEY }}-v7  # üî• ÁâàÊú¨Âè∑ÂçáÁ∫ß
          restore-keys: |
            ccache-${{ env.REPO_BRANCH }}-${{ env.PLUGINS_HASH }}-
            ccache-${{ env.REPO_BRANCH }}-
   
      # ============================================
      # 7. Feeds ÈÖçÁΩÆ
      # ============================================
      - name: üìö Configure Feeds
        run: |
          cd "$OPENWRT_PATH"
          # Á°Æ‰øù feeds ÁõÆÂΩïÂπ≤ÂáÄ
          echo "üßπ Cleaning feeds directory..."
          rm -rf feeds tmp/packagecache
          
          # Â§çÂà∂ feeds ÈÖçÁΩÆÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
          if [ -f "${{ github.workspace }}/feeds.conf.default" ]; then
            cp "${{ github.workspace }}/feeds.conf.default" .
            echo "üìÑ Using custom feeds.conf.default"
          else
            echo "::warning::feeds.conf.default not found, using upstream defaults."
          fi
          ./scripts/feeds update -a
          ./scripts/feeds install -a
      # ============================================
      # 8. ccache ÈÖçÁΩÆ
      # ============================================
      - name: üîß Setup ccache
        run: |
          cd "$OPENWRT_PATH"
          
          export USE_CCACHE=1
          export CCACHE_DIR="$PWD/.ccache"
          export PATH="/usr/lib/ccache:$PATH"
          
          mkdir -p "$CCACHE_DIR"
          
          # üî• Êõ¥ÊøÄËøõÁöÑccacheÈÖçÁΩÆ
          ccache -M 15G  # Â¢ûÂä†Âà∞15G
          ccache -F 150000  # Â¢ûÂä†Êñá‰ª∂Êï∞
          
          # ‰ºòÂåñËÆæÁΩÆ
          ccache --set-config=compression=true
          ccache --set-config=stats=true
          ccache --set-config=max_files=150000
          ccache --set-config=sloppiness=file_macro,locale,time_macros  # üöÄ ÊèêÂçáÂëΩ‰∏≠Áéá
          ccache --set-config=hash_dir=false  # üî• ÊèêÂçáÊÄßËÉΩ
          # üìä ÊòæÁ§∫ÈÖçÁΩÆÂíåÂàùÂßãÁä∂ÊÄÅ
          echo "üìã ccache configuration:"
          ccache --show-config 2>/dev/null || ccache -p 2>/dev/null || echo "ccache config not available"
          echo "üìä Initial ccache statistics:"
          ccache -s 2>/dev/null || echo "ccache initializing..."
      # ============================================
      # 9. Â∫îÁî®Ëá™ÂÆö‰πâÈÖçÁΩÆ
      # ============================================
      - name: üé® Apply Custom Configuration
        env:
          LAN: ${{ github.event.inputs.lan_addr }}
          ROOT_PASSWORD: ${{ github.event.inputs.root_password }}
          ENABLE_DOCKER: ${{ github.event.inputs.docker == 'true' && 'y' || 'n' }}
          ENABLE_SSRP: ${{ github.event.inputs.ssrp == 'true' && 'y' || 'n' }}
          ENABLE_PASSWALL: ${{ github.event.inputs.passwall == 'true' && 'y' || 'n' }}
          ENABLE_NIKKI: ${{ github.event.inputs.nikki == 'true' && 'y' || 'n' }}
          ENABLE_OPENCLASH: ${{ github.event.inputs.openclash == 'true' && 'y' || 'n' }}
          ENABLE_LUCKY: ${{ github.event.inputs.lucky == 'true' && 'y' || 'n' }}
          ENABLE_OAF: ${{ github.event.inputs.oaf == 'true' && 'y' || 'n' }}
        run: |
          cd "$OPENWRT_PATH"
          
          # Â§çÂà∂Ëá™ÂÆö‰πâÊñá‰ª∂
          if [ -d "$GITHUB_WORKSPACE/files" ]; then
            mv $GITHUB_WORKSPACE/files $OPENWRT_PATH/files
          fi
          
          # Â§çÂà∂ÈÖçÁΩÆÊñá‰ª∂
          cp "${{ github.workspace }}/$CONFIG_FILE" .config
          
          # ÊâßË°åËá™ÂÆö‰πâËÑöÊú¨
          if [ -d "${{ github.workspace }}/scripts" ]; then
            find "${{ github.workspace }}/scripts" -name "*.sh" -exec chmod +x {} \;
          fi
          if [ -f "${{ github.workspace }}/$DIY_SCRIPT" ]; then
            chmod +x "${{ github.workspace }}/$DIY_SCRIPT"
            "${{ github.workspace }}/$DIY_SCRIPT"
          fi
          "${{ github.workspace }}/scripts/preset-mihimo-core.sh" "$CLASH_KERNEL"
          "${{ github.workspace }}/scripts/preset-adguard-core.sh" "$CLASH_KERNEL"
          
          # ÁîüÊàêÈÖçÁΩÆ
          echo "‚öôÔ∏è Generating defconfig..."
          make defconfig
          
          # ÊèêÂèñÁõÆÊ†á‰ø°ÊÅØ
          DEVICE_TARGET=$(awk -F'"' '/^CONFIG_TARGET_BOARD=/{print $2}' .config || echo "x86")
          DEVICE_SUBTARGET=$(awk -F'"' '/^CONFIG_TARGET_SUBTARGET=/{print $2}' .config || echo "64")
          
          {
            echo "DEVICE_TARGET=$DEVICE_TARGET"
            echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET"
          } >> $GITHUB_ENV
          
          # Ëé∑ÂèñÊúÄÊñ∞ÁâàÊú¨
          LATEST_RELEASE=$(curl -s "https://api.github.com/repos/openwrt/openwrt/releases/latest" | \
            grep -m1 '"tag_name"' | cut -d'"' -f4 | sed 's/^v//' || echo "unknown")
          echo "LATEST_RELEASE=$LATEST_RELEASE" >> $GITHUB_ENV
          echo "üì± Target: $DEVICE_TARGET-$DEVICE_SUBTARGET"
          echo "üìå Latest Release: $LATEST_RELEASE"

          # ÊòæÁ§∫Êèí‰ª∂Áä∂ÊÄÅ
          echo "üì¶ Plugin Status:"
          echo "  Docker: $ENABLE_DOCKER"
          echo "  SSRP: $ENABLE_SSRP"
          echo "  Passwall: $ENABLE_PASSWALL"
          echo "  OpenClash: $ENABLE_OPENCLASH"
          echo "  Nikki: $ENABLE_NIKKI"
          echo "  Lucky: $ENABLE_LUCKY"
          echo "  OAF: $ENABLE_OAF"
      # ============================================
      # 10. Âº∫Âà∂Ê∏ÖÁêÜ
      # ============================================
      - name: üßπ Clean Build Directory
        if: github.event.inputs.force_clean == 'true'
        run: |
          cd "$OPENWRT_PATH"
          make dirclean
      # ============================================
      # 11. ‰∏ãËΩΩ‰æùËµñÂåÖ
      # ============================================
      - name: üì• Download Packages
        run: |
          cd "$OPENWRT_PATH"
          make download -j$(nproc)
      # ============================================
      # 12. ÁºñËØëÂõ∫‰ª∂
      # ============================================
      - name: üî® Compile Firmware
        id: compile
        run: |
          cd "$OPENWRT_PATH"
          echo "üöÄ Starting firmware compilation with $(nproc) cores..."
          make -j$(nproc)
      - name: üìä Cache Statistics
        if: always()
        run: |
          cd "$OPENWRT_PATH"
          echo "=== Cache Effectiveness Report ==="
          echo "Date: $(date)"
          echo "Branch: ${{ env.REPO_BRANCH }}"
          echo "Plugins Hash: ${{ env.PLUGINS_HASH }}"
          echo "Week Key: ${{ env.WEEK_KEY }}"
          echo ""
          
          echo "üìÅ Directory Sizes:"
          du -sh dl/ 2>/dev/null || echo "dl/: Not found"
          du -sh .ccache/ 2>/dev/null || echo ".ccache/: Not found"
          du -sh staging_dir/ 2>/dev/null || echo "staging_dir/: Not found"
          du -sh build_dir/toolchain-* 2>/dev/null || echo "toolchain build_dir/: Not found"
          echo ""
          
          echo "üéØ ccache Statistics:"
          if command -v ccache >/dev/null 2>&1; then
            export CCACHE_DIR="$PWD/.ccache"
            ccache -s
            echo ""
            echo "üìà Cache Hit Rate:"
            ccache -s | grep -E "(cache hit|cache miss|files in cache)" || echo "Stats not available"
          else
            echo "ccache not available"
          fi
          echo "================================="
      # ============================================
      # 13. Êï¥ÁêÜÂõ∫‰ª∂Êñá‰ª∂
      # ============================================
      - name: üì¶ Organize Firmware
        if: steps.compile.outputs.status == 'success'
        id: organize
        run: |
          cd "$OPENWRT_PATH/bin/targets"/*/*
          echo "=== Generated Files ==="
          ls -lah
          
          # ÂÆâÂÖ®ÊèêÂèñÂÜÖÊ†∏ÁâàÊú¨
          KERNEL_VERSION="unknown"
          if ls *.manifest 1> /dev/null 2>&1; then
            KERNEL_VERSION=$(grep "^kernel " *.manifest | head -1 | awk '{print $3}' | cut -d- -f1-2 || echo "unknown")
          fi
          
          # Â§çÂà∂ÈÖçÁΩÆÊñá‰ª∂
          cp "$OPENWRT_PATH/.config" build.config
          
          # ÊâìÂåÖÂÜÖÊ†∏Ê®°Âùó
          if [ -d packages ]; then
            tar -czf kernel-modules.tar.gz packages/
            rm -rf packages
          fi
          
          # Ê∏ÖÁêÜ‰∏çÈúÄË¶ÅÁöÑÊñá‰ª∂
          rm -f feeds.buildinfo version.buildinfo *.manifest
          
          # ÁîüÊàêÂõ∫‰ª∂‰ø°ÊÅØ
          cat > firmware_info.json <<EOF
          {
            "build_date": "$BUILD_DATE",
            "build_version": "$BUILD_VERSION",
            "build_id": "$BUILD_ID",
            "kernel_version": "$KERNEL_VERSION",
            "target": "$DEVICE_TARGET",
            "subtarget": "$DEVICE_SUBTARGET",
            "lan_address": "${{ github.event.inputs.lan_addr }}",
            "commit_hash": "$COMMIT_HASH",
            "plugins": {
              "docker": ${{ github.event.inputs.docker }},
              "ssrp": ${{ github.event.inputs.ssrp }},
              "passwall": ${{ github.event.inputs.passwall }},
              "openclash": ${{ github.event.inputs.openclash }},
              "nikki": ${{ github.event.inputs.nikki }},
              "lucky": ${{ github.event.inputs.lucky }},
              "oaf": ${{ github.event.inputs.oaf }}
            }
          }
          EOF
          
          # ËæìÂá∫ÁªìÊûú
          {
            echo "firmware_path=$PWD"
            echo "kernel_version=$KERNEL_VERSION"
          } >> $GITHUB_OUTPUT
          
          echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV
      # ============================================
      # 14. ‰∏ä‰º† Artifacts
      # ============================================
      - name: üì§ Upload Artifacts
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_ARTIFACTS == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt-${{ env.DEVICE_TARGET }}-${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE_PATH }}
          retention-days: 30
          compression-level: 6
      # ============================================
      # 15. ÂàõÂª∫ Release
      # ============================================
      - name: üöÄ Create Release
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true'
        uses: ncipollo/release-action@v1.14.0
        with:
          name: ${{ env.FILE_DATE }} ‚Ä¢ ${{ env.FIRMWARE_TAG }} ‚Ä¢ ${{ env.LATEST_RELEASE }}
          allowUpdates: true
          tag: ${{ env.FIRMWARE_TAG }}-${{ env.FILE_DATE }}
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: ${{ env.FIRMWARE_PATH }}/*
          body: |
            ## üéØ OpenWrt Firmware [${{ env.BUILD_ID }}]
            
            ### üìä ÊûÑÂª∫‰ø°ÊÅØ
            | È°πÁõÆ | ‰ø°ÊÅØ |
            |------|------|
            | **ÁâàÊú¨** | `${{ env.LATEST_RELEASE }}` |
            | **Êó•Êúü** | `${{ env.BUILD_DATE }}` |
            | **ÁõÆÊ†á** | `${{ env.DEVICE_TARGET }}_${{ env.DEVICE_SUBTARGET }}` |
            | **ÂÜÖÊ†∏** | `${{ steps.organize.outputs.kernel_version }}` |
            | **LAN IP** | `${{ github.event.inputs.lan_addr }}` |
            | **Password** | `${{ github.event.inputs.root_password }}` |
            
            ### üì¶ ÂåÖÂê´ÁöÑÊèí‰ª∂
            | Êèí‰ª∂ | Áä∂ÊÄÅ |
            |------|------|
            | Docker | ${{ github.event.inputs.docker == 'true' && '‚úÖ Â∑≤ÁºñËØë' || '‚ùå Êú™ÁºñËØë' }} |
            | ShadowSocksR Plus+ | ${{ github.event.inputs.ssrp == 'true' && '‚úÖ Â∑≤ÁºñËØë' || '‚ùå Êú™ÁºñËØë' }} |
            | Passwall | ${{ github.event.inputs.passwall == 'true' && '‚úÖ Â∑≤ÁºñËØë' || '‚ùå Êú™ÁºñËØë' }} |
            | OpenClash | ${{ github.event.inputs.openclash == 'true' && '‚úÖ Â∑≤ÁºñËØë' || '‚ùå Êú™ÁºñËØë' }} |
            | Nikki | ${{ github.event.inputs.nikki == 'true' && '‚úÖ Â∑≤ÁºñËØë' || '‚ùå Êú™ÁºñËØë' }} |
            | Lucky | ${{ github.event.inputs.lucky == 'true' && '‚úÖ Â∑≤ÁºñËØë' || '‚ùå Êú™ÁºñËØë' }} |
            | OpenAppFilter | ${{ github.event.inputs.oaf == 'true' && '‚úÖ Â∑≤ÁºñËØë' || '‚ùå Êú™ÁºñËØë' }} |
            
            ### üìù Ê∫êÁ†Å‰ø°ÊÅØ
            - **‰ªìÂ∫ì**: ${{ env.REPO_URL }}
            - **ÂàÜÊîØ**: `${{ env.REPO_BRANCH }}`
            - **Êèê‰∫§**: `${{ env.COMMIT_HASH }}`
            - **‰ΩúËÄÖ**: ${{ env.COMMIT_AUTHOR }}
            - **Êó∂Èó¥**: ${{ env.COMMIT_DATE }}
            - **Ê∂àÊÅØ**: ${{ env.COMMIT_MESSAGE }}
            
            ### üì• ÂÆâË£ÖËØ¥Êòé
            
            #### UEFI Âõ∫‰ª∂ÔºàÊé®ËçêÔºâÔºö
            ```bash
            gunzip openwrt-*-generic-ext4-combined-efi.img.gz
            dd if=openwrt-*-generic-ext4-combined-efi.img of=/dev/sdX bs=4M status=progress
