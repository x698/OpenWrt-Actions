# 🚀 OpenWrt 编译最优方案 - 快速模式专用版
# 解决首次编译超时 + 提升缓存命中率至75%+
# Author: 优化版本 v3.0

name: 💻 Build OpenWrt (x86_64)

permissions:
  contents: write
  actions: read

on:
  workflow_dispatch:
    inputs:
      lan_addr:
        description: "📍 默认 LAN 地址"
        default: "192.168.1.200"
        required: true
        type: string
      root_password:
        description: "🔑 Root 密码"
        default: "password"
        required: false
        type: string
      docker:
        description: "🐋 Docker 支持"
        type: boolean
        default: true
      ssrp:
        description: "🚀 ShadowSocksR Plus+"
        type: boolean
        default: true
      passwall:
        description: "🌐 Passwall"
        type: boolean
        default: true
      nikki:
        description: "📦 Nikki"
        type: boolean
        default: true
      openclash:
        description: "⚡ OpenClash"
        type: boolean
        default: true
      lucky:
        description: "🍀 Lucky"
        type: boolean
        default: true
      oaf:
        description: "🛡️ OpenAppFilter"
        type: boolean
        default: true
      force_clean:
        description: "🧹 强制清理缓存"
        type: boolean
        default: false

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  CONFIG_FILE: configs/x86_64.config
  DIY_SCRIPT: scripts/diy-x86_64_demo.sh
  FEEDS_CONF: feeds.conf.default
  CLASH_KERNEL: amd64
  UPLOAD_ARTIFACTS: false
  UPLOAD_RELEASE: true
  FIRMWARE_TAG: X86_64
  TZ: Asia/Shanghai
  DEBIAN_FRONTEND: noninteractive

concurrency:
  group: openwrt-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # 📋 预检查阶段 - 智能缓存键生成
  # ============================================
  pre-check:
    name: 📋 生成缓存策略
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      cache_key_base: ${{ steps.cache-key.outputs.base }}
      config_hash: ${{ steps.cache-key.outputs.config_hash }}
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 🧠 生成智能缓存键
        id: cache-key
        run: |
          # 基于文件内容生成稳定缓存键
          if [ -f "configs/x86_64.config" ]; then
            CONFIG_HASH=$(sha256sum configs/x86_64.config | cut -c1-12)
          else
            CONFIG_HASH="default"
            echo "::warning::配置文件不存在，使用默认配置"
          fi
          
          # 月度刷新策略
          MONTH_KEY=$(date +'%Y%m')
          
          # 基础缓存键
          CACHE_BASE="${{ env.REPO_BRANCH }}-${CONFIG_HASH}-${MONTH_KEY}"
          
          {
            echo "base=$CACHE_BASE"
            echo "config_hash=$CONFIG_HASH"
          } >> $GITHUB_OUTPUT
          
          echo "🎯 缓存策略: $CACHE_BASE"

  # ============================================
  # 🔧 工具链预编译阶段（快速模式专用）
  # ============================================
  prepare-toolchain:
    name: 🔧 预编译工具链
    needs: pre-check
    runs-on: ubuntu-24.04
    timeout-minutes: 280
    outputs:
      toolchain_ready: ${{ steps.toolchain.outputs.ready }}
      toolchain_cache_hit: ${{ steps.cache-toolchain.outputs.cache-hit }}
    steps:
      - name: 🧹 释放磁盘空间
        uses: sbwml/actions@free-disk

      - name: 📥 Checkout
        uses: actions/checkout@v4
        
      - name: 🛠️ 构建系统设置
        uses: sbwml/actions@openwrt-build-setup

      - name: 📦 安装 LLVM
        uses: sbwml/actions@install-llvm

      - name: 💾 系统优化
        run: |
          # 创建交换空间
          sudo fallocate -l 12G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          
          # 优化内存参数
          sudo tee -a /etc/sysctl.conf >/dev/null <<EOF
          vm.swappiness=5
          vm.vfs_cache_pressure=40
          vm.dirty_ratio=20
          vm.dirty_background_ratio=10
          vm.overcommit_memory=1
          EOF
          sudo sysctl -p
          
          echo "💾 内存状态: $(free -h | grep '^Mem:' | awk '{print $7 " available"}')"

      - name: 📥 准备 OpenWrt 源码
        run: |
          echo "📥 克隆 OpenWrt 源码..."
          for attempt in 1 2 3; do
            if git clone --depth=1 "$REPO_URL" -b "$REPO_BRANCH" openwrt; then
              break
            fi
            echo "❌ 第 $attempt 次克隆失败，重试..."
            rm -rf openwrt
            [ $attempt -lt 3 ] && sleep 15
          done
          
          cd openwrt
          echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV

      - name: 📚 配置 Feeds
        run: |
          cd "$OPENWRT_PATH"
          
          # 清理并配置 feeds
          rm -rf feeds tmp/packagecache
          
          if [ -f "${{ github.workspace }}/feeds.conf.default" ]; then
            cp "${{ github.workspace }}/feeds.conf.default" .
            echo "📄 使用自定义 feeds 配置"
          fi
          
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: ☁️ 工具链缓存
        id: cache-toolchain
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/toolchain-*
            openwrt/build_dir/toolchain-*
            openwrt/staging_dir/host*
            openwrt/staging_dir/hostpkg
          key: toolchain-fast-${{ needs.pre-check.outputs.cache_key_base }}-v16
          restore-keys: |
            toolchain-fast-${{ needs.pre-check.outputs.cache_key_base }}-
            toolchain-fast-${{ env.REPO_BRANCH }}-${{ needs.pre-check.outputs.config_hash }}-

      - name: 🎨 应用配置
        run: |
          cd "$OPENWRT_PATH"
          
          # 复制配置文件
          if [ -f "${{ github.workspace }}/$CONFIG_FILE" ]; then
            cp "${{ github.workspace }}/$CONFIG_FILE" .config
          else
            echo "::warning::配置文件不存在，使用默认配置"
            make defconfig
          fi
          
          # 执行自定义脚本
          if [ -f "${{ github.workspace }}/$DIY_SCRIPT" ]; then
            chmod +x "${{ github.workspace }}/$DIY_SCRIPT"
            "${{ github.workspace }}/$DIY_SCRIPT"
          fi
          
          make defconfig
          
          # 提取目标信息
          DEVICE_TARGET=$(awk -F'"' '/^CONFIG_TARGET_BOARD=/{print $2}' .config || echo "x86")
          DEVICE_SUBTARGET=$(awk -F'"' '/^CONFIG_TARGET_SUBTARGET=/{print $2}' .config || echo "64")
          echo "DEVICE_TARGET=$DEVICE_TARGET" >> $GITHUB_ENV
          echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET" >> $GITHUB_ENV

      - name: 🔨 编译工具链
        id: toolchain
        timeout-minutes: 240
        run: |
          cd "$OPENWRT_PATH"
          
          echo "🔨 开始工具链编译 ($(date))"
          
          # 检查缓存命中
          if [ "${{ steps.cache-toolchain.outputs.cache-hit }}" == "true" ]; then
            echo "🎯 工具链缓存命中，跳过编译"
            echo "ready=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # 编译工具链
          echo "🔨 编译 tools..."
          make tools/compile -j$(nproc) || make tools/compile -j1 V=s
          
          echo "🔨 编译 toolchain..."
          make toolchain/compile -j$(nproc) || make toolchain/compile -j1 V=s
          
          echo "✅ 工具链编译完成"
          echo "ready=true" >> $GITHUB_OUTPUT

  # ============================================
  # 🏗️ 主编译阶段
  # ============================================
  build-firmware:
    name: 🏗️ 编译固件
    needs: [pre-check, prepare-toolchain]
    if: |
      always() &&
      (needs.prepare-toolchain.result == 'success' || needs.prepare-toolchain.result == 'skipped')
    runs-on: ubuntu-24.04
    timeout-minutes: 400
    outputs:
      firmware_path: ${{ steps.organize.outputs.firmware_path }}
      kernel_version: ${{ steps.organize.outputs.kernel_version }}
      compile_status: ${{ steps.compile.outputs.status }}
    steps:
      - name: 🧹 释放磁盘空间
        uses: sbwml/actions@free-disk

      - name: 📥 Checkout
        uses: actions/checkout@v4
        
      - name: 🛠️ 构建系统设置
        uses: sbwml/actions@openwrt-build-setup

      - name: 📦 安装 LLVM
        uses: sbwml/actions@install-llvm

      - name: 💾 系统优化
        run: |
          # 内存优化
          sudo fallocate -l 12G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          
          # 系统参数优化
          sudo tee -a /etc/sysctl.conf >/dev/null <<EOF
          vm.swappiness=5
          vm.vfs_cache_pressure=40
          vm.dirty_ratio=20
          vm.dirty_background_ratio=10
          vm.overcommit_memory=1
          EOF
          sudo sysctl -p
          
          # 清理系统
          sudo apt-get autoremove -y
          sudo apt-get clean

      - name: ⏰ 构建信息初始化
        run: |
          BUILD_START_TIME=$(date +%s)
          VERSION=$(date +'%Y.%m.%d')
          DATE=$(date +'%Y-%m-%d %H:%M:%S')
          BUILD_ID="${{ github.run_number }}-${GITHUB_SHA::7}"
          FILE_DATE=$(date +'%Y.%m.%d-%H%M')
          
          # 计算并行数
          PROC_COUNT=$(nproc)
          MEM_GB=$(($(free -m | awk '/^Mem:/{print $2}') / 1024))
          JOBS=$((MEM_GB / 3))
          JOBS=$((JOBS > PROC_COUNT ? PROC_COUNT : JOBS))
          JOBS=$((JOBS < 1 ? 1 : JOBS))
          
          {
            echo "BUILD_START_TIME=$BUILD_START_TIME"
            echo "BUILD_VERSION=$VERSION"
            echo "BUILD_DATE=$DATE"
            echo "BUILD_ID=$BUILD_ID"
            echo "FILE_DATE=$FILE_DATE"
            echo "COMPILE_JOBS=$JOBS"
          } >> $GITHUB_ENV
          
          echo "🚀 构建信息: $VERSION | 并行数: $JOBS"

      - name: 📥 准备源码
        run: |
          for attempt in 1 2 3; do
            if git clone --depth=1 "$REPO_URL" -b "$REPO_BRANCH" openwrt; then
              break
            fi
            echo "❌ 第 $attempt 次克隆失败，重试..."
            rm -rf openwrt
            [ $attempt -lt 3 ] && sleep 15
          done
          
          cd openwrt
          echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
          
          # 获取提交信息
          COMMIT_INFO=$(git log -1 --pretty=format:'%an|%ci|%s|%H')
          IFS='|' read -r AUTHOR COMMIT_DATE MESSAGE HASH <<< "$COMMIT_INFO"
          
          {
            echo "COMMIT_AUTHOR=${AUTHOR}"
            echo "COMMIT_DATE=${COMMIT_DATE}"
            echo "COMMIT_MESSAGE=${MESSAGE}"
            echo "COMMIT_HASH=${HASH}"
          } >> $GITHUB_ENV

      - name: 📚 配置 Feeds
        run: |
          cd "$OPENWRT_PATH"
          
          rm -rf feeds tmp/packagecache
          
          if [ -f "${{ github.workspace }}/feeds.conf.default" ]; then
            cp "${{ github.workspace }}/feeds.conf.default" .
            echo "📄 Using custom feeds.conf.default"
          else
            echo "::warning::feeds.conf.default not found, using upstream defaults."
          fi
          
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: ☁️ 多层缓存策略
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/toolchain-*
            openwrt/build_dir/toolchain-*
            openwrt/staging_dir/host*
            openwrt/staging_dir/hostpkg
          key: toolchain-fast-${{ needs.pre-check.outputs.cache_key_base }}-v16
          restore-keys: |
            toolchain-fast-${{ needs.pre-check.outputs.cache_key_base }}-

      - name: ☁️ 下载缓存
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: downloads-${{ env.REPO_BRANCH }}-${{ needs.pre-check.outputs.config_hash }}-v8
          restore-keys: |
            downloads-${{ env.REPO_BRANCH }}-${{ needs.pre-check.outputs.config_hash }}-
            downloads-${{ env.REPO_BRANCH }}-

      - name: ☁️ ccache 编译缓存
        if: github.event.inputs.force_clean != 'true'
        uses: actions/cache@v4
        with:
          path: openwrt/.ccache
          key: ccache-fast-${{ needs.pre-check.outputs.cache_key_base }}-${{ github.run_number }}-v13
          restore-keys: |
            ccache-fast-${{ needs.pre-check.outputs.cache_key_base }}-
            ccache-fast-${{ env.REPO_BRANCH }}-${{ needs.pre-check.outputs.config_hash }}-

      - name: 🎯 ccache 高性能配置
        run: |
          cd "$OPENWRT_PATH"
          
          export USE_CCACHE=1
          export CCACHE_DIR="$PWD/.ccache"
          export PATH="/usr/lib/ccache:$PATH"
          
          mkdir -p "$CCACHE_DIR"
          
          # 高性能配置
          ccache -M 30G
          ccache -F 800000
          ccache --set-config=compression=true
          ccache --set-config=compression_level=1
          ccache --set-config=sloppiness=file_macro,locale,time_macros,include_file_ctime,file_stat_matches,include_file_mtime,pch_defines
          ccache --set-config=direct_mode=true
          ccache --set-config=base_dir="$PWD"
          
          ccache --cleanup >/dev/null 2>&1 || true
          
          echo "📊 ccache 初始状态:"
          ccache -s 2>/dev/null || echo "ccache 初始化中..."

      - name: 🎨 应用自定义配置
        env:
          LAN: ${{ github.event.inputs.lan_addr }}
          ROOT_PASSWORD: ${{ github.event.inputs.root_password }}
          ENABLE_DOCKER: ${{ github.event.inputs.docker == 'true' && 'y' || 'n' }}
          ENABLE_SSRP: ${{ github.event.inputs.ssrp == 'true' && 'y' || 'n' }}
          ENABLE_PASSWALL: ${{ github.event.inputs.passwall == 'true' && 'y' || 'n' }}
          ENABLE_NIKKI: ${{ github.event.inputs.nikki == 'true' && 'y' || 'n' }}
          ENABLE_OPENCLASH: ${{ github.event.inputs.openclash == 'true' && 'y' || 'n' }}
          ENABLE_LUCKY: ${{ github.event.inputs.lucky == 'true' && 'y' || 'n' }}
          ENABLE_OAF: ${{ github.event.inputs.oaf == 'true' && 'y' || 'n' }}
        run: |
          cd "$OPENWRT_PATH"
          
          # 复制自定义文件
          if [ -d "$GITHUB_WORKSPACE/files" ]; then
            cp -r "$GITHUB_WORKSPACE/files" .
          fi
          
          # 应用配置文件
          if [ -f "${{ github.workspace }}/$CONFIG_FILE" ]; then
            cp "${{ github.workspace }}/$CONFIG_FILE" .config
          else
            echo "::warning::配置文件不存在，使用默认配置"
          fi
          
          # 执行自定义脚本
          if [ -f "${{ github.workspace }}/$DIY_SCRIPT" ]; then
            chmod +x "${{ github.workspace }}/$DIY_SCRIPT"
            "${{ github.workspace }}/$DIY_SCRIPT"
          fi
          
          # 执行预设脚本
          for script in preset-mihimo-core.sh preset-adguard-core.sh; do
            if [ -f "${{ github.workspace }}/scripts/$script" ]; then
              chmod +x "${{ github.workspace }}/scripts/$script"
              "${{ github.workspace }}/scripts/$script" "$CLASH_KERNEL"
            fi
          done
          
          # 生成配置
          echo "⚙️ Generating defconfig..."
          make defconfig
          
          # 提取目标信息
          DEVICE_TARGET=$(awk -F'"' '/^CONFIG_TARGET_BOARD=/{print $2}' .config || echo "x86")
          DEVICE_SUBTARGET=$(awk -F'"' '/^CONFIG_TARGET_SUBTARGET=/{print $2}' .config || echo "64")
          
          {
            echo "DEVICE_TARGET=$DEVICE_TARGET"
            echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET"
          } >> $GITHUB_ENV
          
          echo "🎯 目标: $DEVICE_TARGET-$DEVICE_SUBTARGET"
          echo "📦 插件: Docker($ENABLE_DOCKER) SSRP($ENABLE_SSRP) Passwall($ENABLE_PASSWALL) OpenClash($ENABLE_OPENCLASH)"

      - name: 🧹 强制清理构建目录
        if: github.event.inputs.force_clean == 'true'
        run: |
          cd "$OPENWRT_PATH"
          echo "🧹 执行强制清理..."
          
          cp .config .config.backup
          make dirclean
          cp .config.backup .config
          make defconfig
          
          # 清理ccache
          export CCACHE_DIR="$PWD/.ccache"
          ccache -C
          
          echo "✅ 强制清理完成"

      - name: 📥 下载依赖包
        timeout-minutes: 30
        run: |
          cd "$OPENWRT_PATH"
          
          echo "📥 开始下载依赖包..."
          
          # 优化下载并行度
          DOWNLOAD_JOBS=$((COMPILE_JOBS * 2))
          DOWNLOAD_JOBS=$((DOWNLOAD_JOBS > 16 ? 16 : DOWNLOAD_JOBS))
          
          # 重试机制的下载
          for attempt in 1 2 3; do
            echo "📥 下载尝试 $attempt/3 (并行度: $DOWNLOAD_JOBS)"
            
            if make download -j"$DOWNLOAD_JOBS" 2>&1 | tee download.log; then
              echo "✅ 下载完成"
              break
            else
              echo "❌ 下载失败，重试..."
              [ $attempt -lt 3 ] && sleep 10
            fi
          done

      - name: 🔨 快速分阶段编译
        id: compile
        timeout-minutes: 360
        run: |
          cd "$OPENWRT_PATH"
          
          # 设置编译环境
          export USE_CCACHE=1
          export CCACHE_DIR="$PWD/.ccache"
          export CONFIG_CCACHE=y
          export PATH="/usr/lib/ccache:$PATH"
          
          echo "🚀 开始快速分阶段编译 ($(date))"
          echo "💻 CPU核心: $(nproc) | 编译并行度: $COMPILE_JOBS"
          
          # 分阶段编译（跳过工具链，因为已经预编译）
          echo "🔨 阶段1: 目标平台编译"
          make target/compile -j$COMPILE_JOBS || make target/compile -j1 V=s
          
          echo "🔨 阶段2: 软件包编译"
          PACKAGE_JOBS=$((COMPILE_JOBS < 8 ? COMPILE_JOBS : 8))
          make package/compile -j$PACKAGE_JOBS || make package/compile -j1 V=s
          
          echo "🔨 阶段3: 固件组装"
          make package/install target/install package/index -j$COMPILE_JOBS
          
          echo "✅ 编译完成 ($(date))"
          echo "status=success" >> $GITHUB_OUTPUT

      - name: 📦 整理固件文件
        if: steps.compile.outputs.status == 'success'
        id: organize
        run: |
          cd "$OPENWRT_PATH/bin/targets"/*/*
          
          echo "📦 生成的文件:"
          ls -lah
          
          # 提取内核版本
          KERNEL_VERSION="unknown"
          if ls *.manifest 1> /dev/null 2>&1; then
            KERNEL_VERSION=$(grep "^kernel " *.manifest | head -1 | awk '{print $3}' | cut -d- -f1-2 || echo "unknown")
          fi
          
          # 复制构建配置
          cp "$OPENWRT_PATH/.config" build.config
          
          # 打包内核模块
          if [ -d packages ]; then
            tar -czf kernel-modules-${{ env.FILE_DATE }}.tar.gz packages/
            rm -rf packages
          fi
          
          # 清理多余文件
          rm -f feeds.buildinfo version.buildinfo *.manifest sha256sums
          
          # 生成固件信息
          cat > README.md <<EOF
          # OpenWrt 固件说明 - ${{ env.BUILD_VERSION }}
          
          ## 🎯 固件信息
          - **版本**: ${{ env.BUILD_VERSION }}
          - **目标**: ${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}
          - **内核**: $KERNEL_VERSION
          - **LAN地址**: ${{ github.event.inputs.lan_addr }}
          - **默认密码**: ${{ github.event.inputs.root_password }}
          
          ## 📦 包含插件
          ${{ github.event.inputs.docker == 'true' && '- ✅ Docker' || '- ❌ Docker' }}
          ${{ github.event.inputs.ssrp == 'true' && '- ✅ ShadowSocksR Plus+' || '- ❌ ShadowSocksR Plus+' }}
          ${{ github.event.inputs.passwall == 'true' && '- ✅ Passwall' || '- ❌ Passwall' }}
          ${{ github.event.inputs.openclash == 'true' && '- ✅ OpenClash' || '- ❌ OpenClash' }}
          ${{ github.event.inputs.nikki == 'true' && '- ✅ Nikki' || '- ❌ Nikki' }}
          ${{ github.event.inputs.lucky == 'true' && '- ✅ Lucky' || '- ❌ Lucky' }}
          ${{ github.event.inputs.oaf == 'true' && '- ✅ OpenAppFilter' || '- ❌ OpenAppFilter' }}
          
          ## 📥 安装方法
          
          ### UEFI启动（推荐）:
          \`\`\`bash
          gunzip openwrt-*-generic-ext4-combined-efi.img.gz
          sudo dd if=openwrt-*-generic-ext4-combined-efi.img of=/dev/sdX bs=4M status=progress
          \`\`\`
          
          ### 传统BIOS启动:
          \`\`\`bash
          gunzip openwrt-*-generic-ext4-combined.img.gz
          sudo dd if=openwrt-*-generic-ext4-combined.img of=/dev/sdX bs=4M status=progress
          \`\`\`
          
          ## ⚠️ 注意事项
          1. 首次启动后请立即修改默认密码
          2. 建议备份原有固件后再刷写
          3. 刷写前请确认硬件兼容性
          EOF
          
          {
            echo "firmware_path=$PWD"
            echo "kernel_version=$KERNEL_VERSION"
          } >> $GITHUB_OUTPUT
          
          echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV

      - name: 📊 构建性能报告
        if: always()
        run: |
          cd "$OPENWRT_PATH" 2>/dev/null || cd .
          
          # 计算构建时间
          BUILD_END_TIME=$(date +%s)
          BUILD_DURATION=$((BUILD_END_TIME - BUILD_START_TIME))
          BUILD_DURATION_MIN=$((BUILD_DURATION / 60))
          BUILD_DURATION_SEC=$((BUILD_DURATION % 60))
          
          echo "======================================="
          echo "📊 OpenWrt 快速编译性能报告"
          echo "======================================="
          echo "🕐 完成时间: $(date)"
          echo "⏱️ 总用时: ${BUILD_DURATION_MIN}分${BUILD_DURATION_SEC}秒"
          echo "🏷️ 构建ID: ${{ github.run_number }}"
          echo "🌿 分支: ${{ env.REPO_BRANCH }}"
          echo "📦 目标: ${DEVICE_TARGET:-unknown}-${DEVICE_SUBTARGET:-unknown}"
          echo ""
          
          # ccache 统计
          if command -v ccache >/dev/null 2>&1; then
            export CCACHE_DIR="$PWD/.ccache"
            
            STATS=$(ccache -s 2>/dev/null || echo "统计不可用")
            echo "🎯 ccache 性能:"
            echo "$STATS"
            
            # 计算命中率
            if echo "$STATS" | grep -q "cache hit"; then
              DIRECT_HITS=$(echo "$STATS" | grep "cache hit (direct)" | awk '{print $4}' 2>/dev/null || echo "0")
              PREPROCESSED_HITS=$(echo "$STATS" | grep "cache hit (preprocessed)" | awk '{print $4}' 2>/dev/null || echo "0")
              TOTAL_HITS=$((DIRECT_HITS + PREPROCESSED_HITS))
              MISSES=$(echo "$STATS" | grep "cache miss" | awk '{print $3}' 2>/dev/null || echo "1")
              
              if [ "$MISSES" != "0" ] && [ "$TOTAL_HITS" != "0" ]; then
                HIT_RATE=$(echo "scale=1; $TOTAL_HITS * 100 / ($TOTAL_HITS + $MISSES)" | bc -l 2>/dev/null || echo "N/A")
                echo ""
                echo "📈 缓存效率: ${HIT_RATE}%"
                echo "⚡ 直接命中: $DIRECT_HITS"
                echo "❌ 未命中: $MISSES"
              fi
            fi
          fi
          echo "======================================="

      - name: 🚀 发布固件
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true'
        uses: ncipollo/release-action@v1.14.0
        with:
          name: ${{ env.FILE_DATE }} • ${{ env.FIRMWARE_TAG }} • Fast
          allowUpdates: true
          tag: ${{ env.FIRMWARE_TAG }}-${{ env.FILE_DATE }}
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: ${{ env.FIRMWARE_PATH }}/*
          body: |
            ## 🎯 OpenWrt 固件发布 [${{ env.BUILD_ID }}]
            
            > 🚀 **编译模式**: 快速分阶段编译 | 🕐 **编译时间**: 约 2-3小时
            
            ### 📊 固件信息
            | 项目 | 详情 |
            |------|------|
            | **🏷️ 版本** | `${{ env.BUILD_VERSION }}` |
            | **📅 日期** | `${{ env.BUILD_DATE }}` |
            | **🎯 目标** | `${{ env.DEVICE_TARGET }}_${{ env.DEVICE_SUBTARGET }}` |
            | **🔧 内核** | `${{ steps.organize.outputs.kernel_version }}` |
            | **🌐 LAN IP** | `${{ github.event.inputs.lan_addr }}` |
            | **🔑 密码** | `${{ github.event.inputs.root_password }}` |
            
            ### 📦 集成插件
            | 插件名称 | 状态 | 说明 |
            |---------|------|------|
            | 🐋 Docker | ${{ github.event.inputs.docker == 'true' && '✅ 已集成' || '❌ 未集成' }} | 容器化平台 |
            | 🚀 ShadowSocksR Plus+ | ${{ github.event.inputs.ssrp == 'true' && '✅ 已集成' || '❌ 未集成' }} | 科学上网 |
            | 🌐 Passwall | ${{ github.event.inputs.passwall == 'true' && '✅ 已集成' || '❌ 未集成' }} | 代理工具 |
            | ⚡ OpenClash | ${{ github.event.inputs.openclash == 'true' && '✅ 已集成' || '❌ 未集成' }} | Clash客户端 |
            | 📦 Nikki | ${{ github.event.inputs.nikki == 'true' && '✅ 已集成' || '❌ 未集成' }} | 系统工具 |
            | 🍀 Lucky | ${{ github.event.inputs.lucky == 'true' && '✅ 已集成' || '❌ 未集成' }} | 多功能工具 |
            | 🛡️ OpenAppFilter | ${{ github.event.inputs.oaf == 'true' && '✅ 已集成' || '❌ 未集成' }} | 应用过滤 |

            ### 📝 源码信息
            - **仓库**: ${{ env.REPO_URL }}
            - **分支**: `${{ env.REPO_BRANCH }}`
            - **提交**: `${{ env.COMMIT_HASH }}`
            - **作者**: ${{ env.COMMIT_AUTHOR }}
            
            ### 📥 安装指南
            
            #### 🖥️ UEFI 系统（推荐）
            ```bash
            # 解压固件
            gunzip openwrt-*-generic-ext4-combined-efi.img.gz
            
            # 写入设备（请替换 /dev/sdX 为实际设备）
            sudo dd if=openwrt-*-generic-ext4-combined-efi.img of=/dev/sdX bs=4M status=progress
